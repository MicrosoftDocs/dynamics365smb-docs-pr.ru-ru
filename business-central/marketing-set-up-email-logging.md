---
title: Настройка регистрации эл.почты
description: 'Узнайте, как превратить взаимодействие по электронной почте между продавцами и клиентами в реальные возможности продаж.'
author: brentholtorf
ms.topic: conceptual
ms.devlang: na
ms.tgt_pltfrm: na
ms.workload: na
ms.search.keywords: 'relationship, prospect, opportunity, email'
ms.date: 03/22/2022
ms.search.form: '1680, 1811, 5076'
ms.author: bholtorf
---
# Отслеживание обмена сообщениями электронной почты между продавцами и контактами
Получите больше от общения между продавцами вашими и клиентами, отслеживая обмен сообщениями электронной почты, затем превращая их в реальные возможности. [!INCLUDE[prod_short](includes/prod_short.md)] может работать с Exchange Online, чтобы вести журнал входящих и исходящих сообщений. Вы можете просматривать и анализировать содержимое каждого сообщения на странице **Журналы взаимодействий**.

> [!NOTE]
> В волне 1 выпуска 2022 года мы оптимизировали процессы настройки ведения журнала электронной почты, чтобы повысить гибкость и безопасность. Если вы новый клиент, использующий эту версию, вы используете новую версию. Если вы уже являетесь клиентом, то используете ли вы новый интерфейс, зависит от того, включил ли ваш администратор обновление функции **Регистрация электронной почты с помощью Microsoft Graph API** на странице **Управление функциями**. Для получения дополнительной информации см. [Раннее включение новых функций](/dynamics365/business-central/dev-itpro/administration/feature-management).

> [!IMPORTANT]
> Для [!INCLUDE[prod_short](includes/prod_short.md)] онлайн новый интерфейс требует, чтобы [!INCLUDE[prod_short](includes/prod_short.md)] и Exchange Online находились в одном клиенте.

## Настройка регистрации электронной почты
Эти шаги различаются в зависимости от того, включил ли ваш администратор обновление функции **Регистрация электронной почты с помощью Microsoft Graph API**. Если обновление функции не включено, следуйте инструкциям на вкладке **Текущая версия**.

## [Текущая версия](#tab/current-experience)

### Настройка общих папок и правил для регистрации электронной почты в Exchange Online

[!INCLUDE[admin-setup-email-public-folder](includes/admin-setup-email-public-folder.md)]

Далее вы подключаете [!INCLUDE[prod_short](includes/prod_short.md)] с Exchange Online.

## [Новая версия](#tab/new-experience)
### Настройка общего почтового ящика и правил для регистрации электронной почты в Exchange Online

> [!NOTE]
> Эти шаги требуют доступа администратора для Exchange Online.

Подготовьте общий почтовый ящик в центре администрирования Exchange. Или вы также можете использовать Exchange Online PowerShell. Для получения дополнительной информации см. [Создание общего почтового ящика](/microsoft-365/admin/email/create-a-shared-mailbox) или [Exchange Online PowerShell](/powershell/exchange/exchange-online-powershell?view=exchange-ps&preserve-view=true).

> [!NOTE]
> Если вы используете Exchange Management PowerShell, ваши изменения доступны в центре администрирования Exchange через некоторое время. Задержка может составить несколько часов.

### Добавить учетную запись пользователя для членов общего почтового ящика
Учетная запись, которую вы будете использовать для ведения журнала электронной почты, является учетной записью Exchange Online. Запланированное задание будет использовать учетную запись для подключения к общему почтовому ящику и обработки сообщений электронной почты. Эта учетная запись не должна быть связана с конкретным человеком. Добавьте учетную запись электронной почты к участникам общего почтового ящика. Для получения дополнительной информации см. [Использование EAC для изменения делегирования общего почтового ящика](/exchange/collaboration-exo/shared-mailboxes#use-the-eac-to-edit-shared-mailbox-delegation).

### Разрешить другим пользователям просматривать зарегистрированные электронные письма
Вы можете разрешить другому пользователю открывать сообщение электронной почты в Exchange, связанное с записью журнала взаимодействий из [!INCLUDE[prod_short](includes/prod_short.md)]. Для этого дайте пользователю разрешение ``Read`` для папки **Архив** в общем почтовом ящике. Дополнительные сведения см. также в разделе [Exchange Online PowerShell](/powershell/exchange/exchange-online-powershell?view=exchange-ps&preserve-view=true).

### Создать правила потока почты
Правила обработки почты ищут определенные условия в сообщениях и выполняют над ними действия. Создайте два правила потока почты на основе информации в следующей таблице. Дополнительные сведения см. в [Управлять правилами потока почты в Exchange Online](/exchange/security-and-compliance/mail-flow-rules/manage-mail-flow-rules?preserve-view=true) и [Действия правила потока почты в Exchange Online](/exchange/security-and-compliance/mail-flow-rules/mail-flow-rule-actions?preserve-view=true).

|Назначение  |Name  |Примените это правило, если...  |Выполните следующие действия...  |
|---------|---------|---------|---------|
|Правило для входящей эл. почты     |Регистрировать сообщения электронной почты, присланные в эту организацию|Отправитель расположен вне организации, и получатель расположен внутри организации|Скрытая копия учетная запись электронной почты, указанная для общем почтовом ящике.|
|Правило для исходящей эл. почты     |Регистрировать сообщения электронной почты, отправленные из этой организации|Отправитель расположен внутри организации, и получатель расположен вне организации.|Скрытая копия учетная запись электронной почты, указанная для общем почтовом ящике.|

> [!NOTE]
> [!INCLUDE[prod_short](includes/prod_short.md)] обрабатывает только сообщения в папке Входящие в общем почтовом ящике. Если правило перемещает сообщения из папки «Входящие» в другую папку, эти сообщения не будут обрабатываться. Кроме того, сообщения в папке «Нежелательная почта» также игнорируются. 

---

## Настройка [!INCLUDE[prod_short](includes/prod_short.md)] для регистрации сообщений электронной почты
Эти шаги одинаковы как для текущего, так и для нового интерфейса.

Начните работать с регистрацией электронной почты за два простых шага:

1. Соедините [!INCLUDE[prod_short](includes/prod_short.md)] с Exchange Online для своей подписки Microsoft 365. Exchange Online обрабатывает ваши сообщения электронной почты. Мы упростили этот шаг, предоставив мастер настройки. Вам нужны только ваши учетные данные администратора для вашей учетной записи администратора в Microsoft 365. Чтобы запустить руководство, выберите страницу **Мастер настройки**, затем выберите руководство **Настройка регистрации электронной почты**.  

2. Убедитесь, что адреса электронной почты ваших продавцов и контактов в [!INCLUDE[prod_short](includes/prod_short.md)] действительны. Для этого для каждого клиента или продавца откройте карточку **Контакт** или **Менеджер по продажам/закупкам** и посмотрите в поле **Адрес эл. почты**.

> [!Tip]
> После выполнения шагов в руководстве вы можете проверить, было ли соединение успешным. В зависимости от того, используете ли вы текущий или новый интерфейс, выполните одно из следующих действий: 
>
> * **Текущая версия**: выполните поиск **Настройка модуля "Маркетинг"**, выберите **Доступ**, затем **Функции**, потом **Проверить настройку регистрации эл. почты**.
> * **Новая версия**: найдите **Регистрация электронной почты**, выберите **Действия**, а затем выберите **Проверить конфигурацию**.

## Просмотр обмена сообщениями электронной почты в журнале взаимодействия

[!INCLUDE[prod_short](includes/prod_short.md)] создает запись на странице **Журнал взаимодействия** каждый раз, когда продавец и контакт обмениваются сообщениями электронной почты. Чтобы просмотреть журнал взаимодействия, откройте карточку **Контакт** для человека, затем выберите **Связанный**, **История**, затем выберите **Журналы взаимодействий**. Есть несколько вещей, которые мы можем сделать с каждой записью в журнале, например:

- Просмотрите содержимое сообщения электронной почты, которым обменялись собеседники, выбрав **Обработка**, затем **Показать вложения**.
- Превратите обмен электронной почтой в возможную сделку продажи. Если запись выглядит многообещающе, вы можете превратить ее в возможную сделку, а затем управлять ее продвижением к продаже. Чтобы превратить обмен электронной почтой в возможную сделку, выберите запись, а затем **Обработать**, а потом **Создать возможность**. Дополнительные сведения см. в разделе [Управление возможностями продаж](marketing-manage-sales-opportunities.md).

## Ограничения на почтовые ящики и папки в Exchange Online
В Exchange Online существуют ограничения на почтовые ящики и папки, например на размер папок и количество сообщений. Дополнительные сведения см. в разделах [Ограничения Exchange Online](/office365/servicedescriptions/exchange-online-service-description/exchange-online-limits#storage-limits) и [Ограничения общедоступных папок в Exchange Server](/Exchange/collaboration/public-folders/limits?view=exchserver-2019).

[!INCLUDE[prod_short](includes/prod_short.md)] хранит зарегистрированные сообщения электронной почты в папке Exchange Online. [!INCLUDE[prod_short](includes/prod_short.md)] также хранит ссылку на каждое зарегистрированное сообщение. По ссылкам открываются зарегистрированные сообщения со страниц "Журналы взаимодействий", "Карточка контакта" и "Карточка менеджера по продажам" в [!INCLUDE[prod_short](includes/prod_short.md)] в Exchange Online. Если зарегистрированное сообщение перемещено в другую папку, ссылка не будет работать. Например, сообщение может быть перемещено вручную, или Exchange Online может автоматически запустить функцию AutoSplit при достижении ограничения хранилища.

Следующие шаги могут помочь вам избежать неработающих ссылок на сообщения в Exchange Online.

1. Не перемещайте существующие сообщения в другую папку после изменения настроек журнала регистрации электронной почты. Храните существующие сообщения там, где они есть, чтобы сохранить ссылки. Ссылки на сообщения в новой папке будут действительными.
2. Не превышайте ограничения почтовых ящиков и папок. Если ограничение скоро будет достигнуто, выполните следующие действия:
    1. Настройте новый общий почтовый ящик (новый интерфейс) или новую общую папку (текущий интерфейс) в Exchange Online.
    2. Обновите правила потока электронной почты в Exchange Online.
    3. Обновите настройки журнала регистрации электронной почты в Business Central соответствующим образом

## Подключение локальных версий к Microsoft Exchange

Вы можете подключить локальную версию [!INCLUDE[prod_short](includes/prod_short.md)] к локальной версии Exchange On-Premises или Exchange Online для регистрации электронной почты. Для обеих версий Exchange настройки подключения доступны на странице **Настройка модуля "Маркетинг"**. Для Exchange Online вы также можете воспользоваться мастером настройки.

> [!IMPORTANT]
> Новый интерфейс не поддерживает подключение к локальному Exchange. Если вы должны использовать Exchange локально, не включайте обновление компонентов для нового интерфейса.

## Подключение к локальной версии Exchange
## [Текущая версия](#tab/current-experience)
Для подключения [!INCLUDE[prod_short](includes/prod_short.md)] On-Premises к Exchange On-Premises на странице **Настройка модуля "Маркетинг"** вы можете использовать **Базовый** как **Тип аутентификации**, затем введите учетные данные для учетной записи пользователя для Exchange On-Premises. Затем включите переключатель **Включено**, чтобы начать регистрацию электронной почты.

## [Новая версия](#tab/new-experience)
Новый интерфейс не поддерживает подключения к локальному Exchange.

---

## Подключение к Exchange Online
Для подключения к Exchange Online необходимо зарегистрировать приложение в Azure Active Directory. Укажите идентификатор приложения, секрет хранилища ключей и URL-адрес перенаправления для использования для регистрации. URL-адрес перенаправления предварительно задан и должен работать для большинства установок. Дополнительные сведения см. в разделе [Регистрация приложения в Azure AD для подключения из Business Central к Exchange Online](marketing-set-up-email-logging.md#to-register-an-application-in-azure-ad-for-connecting-from-business-central-to-exchange-online). 

Также вы должны использовать **OAuth2** как **Тип аутентификации**. Также необходимо зарегистрировать приложение в Azure Active Directory. Укажите идентификатор приложения, секрет хранилища ключей и URL-адрес перенаправления для использования для регистрации. URL-адрес перенаправления предварительно заполнен и должен работать для большинства установок. Дополнительные сведения см. в разделе Регистрация приложения в Azure AD для подключения из Business Central к Exchange Online ниже.

Вы должны настроить вашу установку на использование HTTPS. Для получения дополнительной информации см. [Настройка SSL для защиты подключения веб-клиента Business Central](/dynamics365/business-central/dev-itpro/deployment/configure-ssl-web-client-connection). Если вы настраиваете на своем сервере другую начальную страницу, вы можете изменить URL-адрес. Секрет клиента будет сохранен как зашифрованная строка в вашей базе данных.

### Чтобы зарегистрировать заявку в Azure AD для подключения из Business Central к Exchange Online
Следующие шаги предполагают, что вы используете Azure Active Directory, чтобы управлять удостоверениями и доступом. Дополнительные сведения см. в [Быстрый старт: зарегистрируйте приложение на платформе идентификации Microsoft](/azure/active-directory/develop/quickstart-register-app). 

## [Текущая версия](#tab/current-experience) 
Следующие шаги предполагают, что вы используете Azure Active Directory, чтобы управлять удостоверениями и доступом. Дополнительные сведения см. в [Быстрый старт: зарегистрируйте приложение на платформе идентификации Microsoft](/azure/active-directory/develop/quickstart-register-app). Если вы не используете Azure Active Directory, см. [Использование другой службы управления удостоверениями и доступом](marketing-set-up-email-logging.md#use-another-identity-and-access-management-service). 

1. В Azure Portal, в пункте **Управление** выберите **Аутентификация**.
2. В пункте **URL-адрес перенаправления** добавьте URL-адрес перенаправления, который предлагается на страница **Настройка модуля "Маркетинг"** в [!INCLUDE[prod_short](includes/prod_short.md)]. Если URL-адрес перенаправления на странице настройки Marketing пуст, найдите предлагаемый URL-адрес перенаправления на странице **Настройка регистрации электронной почты**.

    > [!NOTE]
    > Если вы не укажете URL-адрес перенаправления, вы можете сделать это позже, выбрав **Добавить платформу**, затем выбрав **Интернет**, чтобы добавить веб-приложение и URL-адрес перенаправления. 

3. В разделе **Управление** выберите **Манифест**.
4. Найдите свойство **requiredResourceAccess** в манифесте и добавьте следующий код в скобках ([]), чтобы добавить требуемые разрешения. Дополнительные сведения см. в разделе [Регистрация приложения](/exchange/client-developer/exchange-web-services/how-to-authenticate-an-ews-application-by-using-oauth#register-your-application).

```
{
    "resourceAppId": "00000002-0000-0ff1-ce00-000000000000",
    "resourceAccess": [
        {
            "id": "3b5f3d61-589b-4a3c-a359-5dd4b5ee5bd5",
            "type": "Scope"
        },
        {
            "id": "dc890d15-9560-4a4c-9b7f-a736ec74ec40",
            "type": "Role"
        }
    ]
}
```

5. Выберите **Сохранить**.
6. В разделе **Управление** выберите **Разрешения API**, затем убедитесь, что указаны следующие разрешения:  

    * EWS.AccessAsUser.All
    * full_access_as_app

7. В **управлять** выберите **Сертификаты и секреты**, а затем создайте новый секрет для вашего приложения. Вы будете использовать секрет в [!INCLUDE[prod_short](includes/prod_short.md)], в поле **Секрет клиента** на странице **Настройка модуля "Маркетинг"** или сохраните его в безопасном хранилище и предоставьте его в подписчике события.
8. Выберите **обзор**, а затем найдите значение **Код приложения (клиента)**. Значение **Код приложения (клиента)** — идентификатор клиента вашего приложения. Вы должны код клиента либо на странице **Настройка модуля "Маркетинг"**, в поле **Код клиента** или сохранить его в безопасном хранилище и предоставить его подписчику события.
9. В [!INCLUDE[prod_short](includes/prod_short.md)] настройте регистрацию электронной почты на странице **Настройка модуля "Маркетинг"** или используйте мастер **Настройка регистрации электронной почты** для помощи в процессе.
    * Укажите учетную запись электронной почты пользователя, от имени которого запланированное задание будет подключаться к Exchange Online и обрабатывать сообщения электронной почты. У пользователя должна быть действующая лицензия на Exchange Online.
    * Укажите URL-адрес вашего Exchange Online. Обычно этот URL-адрес — это домен, который вы указали в адресе электронной почты пользователя.
    * Укажите **Путь к папке очереди** и **Путь к папке хранения**.
10. Чтобы начать регистрацию электронной почты, включите переключатель **Включено**.
11. Войдите в систему с учетной записью администратора для Azure Active Directory (эта учетная запись должна иметь действующую лицензию для Exchange и быть администратором в вашем Exchange Online). После входа в систему следует разрешить зарегистрированному приложению войти в Exchange Online от имени организации. Вы должны дать согласие на завершение установки.

   > [!NOTE]
   > Если вам не предлагается войти в систему с учетной записью администратора, возможно, это связано с блокировкой всплывающих окон. Чтобы войти, разрешите всплывающие окна от https://login.microsoftonline.com.

## [Новая версия](#tab/new-experience)
1. В Azure Portal, в пункте **Управление** выберите **Аутентификация**.
2. В пункте **URL-адрес перенаправления** добавьте URL-адрес перенаправления, который предлагается на страница **Регистрация электронной почты** в [!INCLUDE[prod_short](includes/prod_short.md)]. Если поле URL-адреса перенаправления на странице регистрации электронной почты пуст, найдите предлагаемый URL-адрес перенаправления на странице **Мастер настройки**. Чтобы открыть страницу, на странице **Регистрация электронной почты**, выберите **Действия**, а потом **Мастер настройки**.

    > [!NOTE]
    > Если вы не укажете URL-адрес перенаправления, вы можете сделать это позже, выбрав **Добавить платформу**, затем выбрав **Интернет**, чтобы добавить веб-приложение и URL-адрес перенаправления.

3. В **Управление** выберите **Разрешения API** и выберите **Microsoft Graph**, а затем выберите **Делегированные разрешения**.
4. Используйте поле поиска, чтобы найти и выбрать **Почта**, а затем добавьте разрешение **Mail.ReadWrite.Shared**. 
5. В **Управление** выберите **Сертификаты и секреты**, а затем создайте новый секрет для вашего приложения. Вы будете использовать секрет в поле **Секрет клиента** на странице **Регистрация электронной почты** в [!INCLUDE[prod_short](includes/prod_short.md)].
6. Выберите **обзор**, а затем найдите значение **Код приложения (клиента)**. Это код клиента вашего приложения. Вы должны ввести его либо в поле **Код клиента** на странице **Регистрация электронной почты**.
7. В [!INCLUDE[prod_short](includes/prod_short.md)] настройте регистрацию электронной почты на странице **Регистрация электронной почты** или используйте **Мастер настройки** для помощи.

### Использование другой службы управления удостоверениями и доступом
Если вы не используете Azure Active Directory для управления удостоверениями и доступом, вам потребуется помощь разработчика. Если вы предпочитаете хранить код приложения и секрет в другом месте, вы можете оставить поля «Код клиента» и «Секрет клиента» пустыми и написать расширение для получения кода и секрета из местоположения. Вы можете предоставить секрет во время выполнения, подписавшись на события OnGetEmailLoggingClientId и OnGetEmailLoggingClientSecret в codeunit 1641 "Настройка регистрации электронной почты".

---

## Начала регистрации электронной почты
1. Чтобы начать регистрацию электронной почты, на странице **Регистрация электронной почты** включите переключатель **Включено**.
2. Войдите с учетной записью Exchange Online, которую запланированное задание будет использовать для подключения к общему почтовому ящику и обработки сообщений электронной почты.

    > [!NOTE]
    > Если вам не предлагается войти в систему с учетной записью Exchange Online, возможно, это связано с блокировкой всплывающих окон браузером. Чтобы войти, разрешите всплывающие окна от https://login.microsoftonline.com.

## Остановка регистрации электронной почты
## [Текущая версия](#tab/current-experience)
1. Выберите ![Лампочка, которая открывает функцию Что вы хотите сделать.](media/ui-search/search_small.png "Что вы хотите сделать") значок, введите **Настройка модуля "Маркетинг"**, а затем выберите связанную ссылку.
1. Выключите переключатель **Включено**.

## [Новая версия](#tab/new-experience)
1. Выберите ![Лампочка, которая открывает функцию Что вы хотите сделать.](media/ui-search/search_small.png "Что вы хотите сделать") введите **Регистрация электронной почты**, а затем выберите связанную ссылку.
2. Выключите переключатель **Включено**.

---

## Чтобы изменить учетную запись пользователя, используемую для регистрации электронной почты
Если вы используете новый интерфейс, вы можете изменить учетную запись пользователя, используемую для регистрации электронной почты. Текущая версия это не поддерживает.

## [Текущая версия](#tab/current-experience) 
Отключите текущую настройку, измените пользователя на странице **Регистрация электронной почты**, а затем снова включите регистрацию электронной почты. Вы также можете запустить мастер настройки снова.

## [Новая версия](#tab/new-experience)
### [!INCLUDE[prod_short](includes/prod_short.md)] Online
1. Войдите в [!INCLUDE[prod_short](includes/prod_short.md)] с учетной записью, которую запланированное задание будет использовать для подключения к общему почтовому ящику и обработки сообщений электронной почты. Эта учетная запись должна иметь доступ к [!INCLUDE[prod_short](includes/prod_short.md)] и Exchange Online.
2. Выберите ![Лампочка, которая открывает функцию Что вы хотите сделать.](media/ui-search/search_small.png "Что вы хотите сделать") введите **Регистрация электронной почты**, а затем выберите связанную ссылку. 
3. Выберите **Связанный**, а потом **Операция очереди работ**.
4. Перезапустите задание **Регистрация электронной почты**.

### Локальная версия [!INCLUDE[prod_short](includes/prod_short.md)]
1. Выберите ![Лампочка, которая открывает функцию Что вы хотите сделать.](media/ui-search/search_small.png "Что вы хотите сделать") введите **Регистрация электронной почты**, а затем выберите связанную ссылку. 
2. Выберите **Действия**, а потом **Продлить маркер**.
3. Войдите с учетной записью Exchange Online, которую запланированное задание будет использовать для подключения к общему почтовому ящику и обработки сообщений электронной почты.



## См. также
[Управление отношениями](marketing-relationship-management.md)



[!INCLUDE[footer-include](includes/footer-banner.md)]